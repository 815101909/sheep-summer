<!-- pages/article-detail/article-detail.wxml -->
<wxs module="utils">
  module.exports.includes = function(arr, item) {
    return arr.indexOf(item) > -1;
  }
</wxs>
<!-- èƒŒæ™¯å±‚ -->
<view class="background-container {{themeClass}}">
  <image class="background-image" src="/assets/images/splash-bg.png" mode="aspectFill" />
</view>

<!-- ä¾§è¾¹æ é£æ ¼é€‰æ‹© -->
<view class="sidebar" wx:if="{{!isSmallCard}}">
  <view class="mode-selector">
    <view class="mode-btn {{currentStyleIndex === 0 ? 'active main-active' : ''}}" bindtap="switchStyle" data-index="0">
      <!-- ä¸»ä½“å¼å›¾ç‰‡ -->
      <view class="style-image-container {{currentStyleIndex === 0 ? 'visible' : ''}}">
        <image class="style-image" src="{{currentStyleImage}}" mode="aspectFit" />
      </view>
      <text class="mode-text">å……ç”µç«™</text>
    </view>
    <view class="mode-btn {{currentStyleIndex === 1 ? 'active qa-active' : ''}}" bindtap="switchStyle" data-index="1">
      <!-- é—®ç­”å¼å›¾ç‰‡ -->
      <view class="style-image-container {{currentStyleIndex === 1 ? 'visible' : ''}}">
        <image class="style-image" src="{{currentStyleImage}}" mode="aspectFit" />
      </view>
      <text class="mode-text">è¡¥ç»™ç«™</text>
    </view>
    <view class="mode-btn {{currentStyleIndex === 2 ? 'active inspire-active' : ''}}" bindtap="switchStyle" data-index="2">
      <!-- åŠ æ²¹å¼å›¾ç‰‡ -->
      <view class="style-image-container {{currentStyleIndex === 2 ? 'visible' : ''}}">
        <image class="style-image" src="{{currentStyleImage}}" mode="aspectFit" />
      </view>
      <text class="mode-text">å‡€åœŸç«™</text>
    </view>
    <view class="mode-btn {{currentStyleIndex === 3 ? 'active fashion-active' : ''}}" bindtap="switchStyle" data-index="3">
      <!-- æ—¶å…‰ç«™å›¾ç‰‡ -->
      <view class="style-image-container {{currentStyleIndex === 3 ? 'visible' : ''}}">
        <image class="style-image" src="{{currentStyleImage}}" mode="aspectFit" />
      </view>
      <text class="mode-text">æ—¶å…‰ç«™</text>
    </view>
  </view>
</view>

<!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="action-buttons" wx:if="{{!isSmallCard}}">
    <view class="action-btn font-btn" bindtap="toggleFontSize">
      <text class="action-text">Aa</text>
    </view>
    <view class="action-btn favorite-btn {{isFavorited ? 'favorited' : ''}}" bindtap="toggleFavorite">
      <view class="css-heart {{isFavorited ? 'filled' : ''}}"></view>
    </view>
    <view class="action-btn print-btn" bindtap="goToPrint">
      <view class="css-print"></view>
    </view>
  </view>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<view class="main-content {{themeClass}} {{isSmallCard ? 'a4-mode' : ''}}">
  <image class="page-avatar" wx:if="{{isSmallCard && !(showWorryModal || isAnimating)}}" src="{{currentAvatar || '/assets/images/å°å¡ç‰‡é»˜è®¤å½¢è±¡.png'}}" mode="aspectFit" bindtap="onCharacterTap" />
  <view class="page-avatar-tip" wx:if="{{isSmallCard && showAvatarTip && !(showWorryModal || isAnimating)}}">
    <text class="page-avatar-tip-text">{{avatarTipText}}</text>
    <view class="page-avatar-tip-arrow"></view>
  </view>
  <!-- å°å¡ç‰‡A4åŒºåŸŸ -->
  <view class="a4-container {{isSmallCard ? 'active' : ''}}" wx:if="{{isSmallCard}}">
      <view class="a4-top">
      <view class="a4-top-wrap">
        <image class="a4-top-image" src="{{topImageSmallCardUrl}}" mode="aspectFill" />
        <view class="a4-top-overlay">
          <view class="a4-date-badge">
            <image class="date-icon" src="/assets/images/æ—¥æœŸå‰å°ç¾Š.png" mode="aspectFit" />
            <text>{{article.date}}</text>
          </view>
        </view>
      </view>
      <text class="a4-top-text">å¦‚æœæœ‰ä»€ä¹ˆä¸å¼€å¿ƒçš„å°±å¼¹èµ°å§ï¼</text>
        <view class="a4-actions">
          <view class="audio-btn a4-primary-btn" bindtap="openWorryModal">
            <text class="audio-text">å¼¹èµ°çƒ¦æ¼</text>
          </view>
        </view>
      </view>
  </view>

  <!-- æç¤ºä¾¿ç­¾ - æ˜¾ç¤ºåœ¨A4åŒºåŸŸå¤–é¢ -->
  <view class="tip-label {{showTipLabel ? 'show' : '' }}" wx:if="{{isSmallCard}}">
    <text class="tip-text">åšæŒæ‰“å¡ï¼Œå¯è§£é”æ›´å¤šå½¢è±¡</text>
    <view class="tip-arrow"></view>
  </view>
  <view class="custom-modal-mask" wx:if="{{showWorryModal}}" bindtap="closeWorryModal">
    <view class="custom-modal-content worry-modal-content" catchtap="stopProp">
      <image class="modal-bg" src="/assets/images/splash-bg.png" mode="aspectFill" />
      <view class="modal-body">
        <view class="modal-title">æŠŠçƒ¦æ¼å‘Šè¯‰å°ç»µç¾Š</view>
        <textarea class="worry-input" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä»Šå¤©çš„çƒ¦æ¼..." bindinput="onWorryInput" value="{{worryText}}" maxlength="50"></textarea>
        <view class="action-btn-row">
          <view class="voice-btn-container" catchtouchstart="startRecord" catchtouchend="stopRecord">
            <text class="voice-icon">ğŸ¤</text>
            <text class="voice-text">{{isRecording ? 'æ¾å¼€' : 'æŒ‰ä½è¯´è¯'}}</text>
          </view>
          <view class="modal-btn" bindtap="submitWorry">æäº¤å¹¶å¼¹èµ°</view>
        </view>
      </view>
    </view>
  </view>
  <view class="animation-layer" wx:if="{{isAnimating}}">
    <view class="running-sheep-container">
      <image class="running-sheep-image" src="/assets/images/å°ç»µç¾Š.png" mode="aspectFit" />
    </view>
    <view class="falling-char" wx:for="{{fallingChars}}" wx:key="index" style="left:{{item.left}}%; font-size:{{item.size}}rpx; animation-duration:{{item.duration}}s; animation-delay:{{item.delay}}s; --bounce-dir:{{item.bounceDir}};">
      {{item.char}}
    </view>
    <view class="encouraging-text" wx:if="{{showEncouragingText}}">{{encouragingText}}</view>
    <view class="close-animation-btn" bindtap="closeAnimation">Ã—</view>
  </view>

  <!-- éšè—çš„Canvasï¼Œç”¨äºç”Ÿæˆèƒ½é‡å¡ç‰‡ -->
  <canvas type="2d" id="energyCardCanvas" style="position: fixed; left: -9999px; width: 375px; height: 375px;"></canvas>
  <canvas type="2d" id="courageCardCanvas" style="position: fixed; left: -9999px; width: 375px; height: 375px;"></canvas>
  <canvas type="2d" id="solitudeCardCanvas" style="position: fixed; left: -9999px; width: 375px; height: 375px;"></canvas>
  <canvas type="2d" id="timeCapsuleCanvas" style="position: fixed; left: -9999px; width: 375px; height: 375px;"></canvas>
  <canvas type="2d" id="compressCanvas" style="position: fixed; left: -9999px; width: 750px; height: 1334px;"></canvas>

  <!-- å†…å®¹é¢æ¿å®¹å™¨ -->
  <view class="content-panels" wx:if="{{!isSmallCard}}">
    <!-- ä¸»ä½“å¼é¢æ¿ï¼šæƒ…ç»ªå……ç”µç«™ -->
    <view class="content-panel article-panel {{currentStyleIndex === 0 ? 'active' : ''}}">
      <scroll-view class="panel-scroll" scroll-y="true" enable-flex="true">
        <view class="energy-station-style">
          
          <!-- é¡¶éƒ¨ Banner å›¾ç‰‡ -->
          <view class="station-banner" wx:if="{{chargingStationImage}}">
            <view class="card-container station-card">
              <view class="card-image-section">
                <image class="card-image" src="{{chargingStationImage}}" mode="aspectFill" />
                <view class="banner-subtitle">ä»Šå¤©çš„ä½ ï¼Œèƒ½é‡å€¼å‡ åˆ†ï¼Ÿ</view>
              </view>
              <view class="card-divider"></view>
            </view>
          </view>

          <!-- å¤´éƒ¨æ ‡é¢˜å·²ç§»åŠ¨åˆ° Banner å†…éƒ¨ä½œä¸ºå­—å¹• -->

          <!-- æ¯æ—¥å°é¢ä¸æ ‡é¢˜ -->
          <view class="daily-section">
            <image class="daily-cover" src="{{article.cover}}" mode="aspectFill" />
            <view class="daily-info">
               <view class="daily-header-group">
                 <text class="daily-tag">ä»Šæ—¥æ­£èƒ½é‡</text>
                 <text class="daily-title">{{article.title}}</text>
                 <view class="daily-divider-line"></view>
               </view>
               
               <view class="daily-content-wrapper">
                 <text class="daily-content">{{article.content}}</text>
               </view>
            </view>
          </view>

          <!-- èƒ½é‡æ˜Ÿçº§ -->
          <view class="form-section">
            <view class="section-label inline">
              <view class="css-battery-container battery-inline">
                <view class="css-battery">
                  <view class="battery-core">
                    <view class="battery-bolt"></view>
                  </view>
                </view>
              </view>
              <text>é€‰æ‹©å½“æ—¥èƒ½é‡æ˜Ÿçº§</text>
            </view>
            <view class="energy-stars">
              <view class="star-item" wx:for="{{5}}" wx:key="index" bindtap="selectEnergy" data-level="{{index+1}}">
                 <text class="star-icon {{energyLevel > index ? 'filled' : ''}}">â˜…</text>
              </view>
            </view>
          </view>

          <!-- æƒ…ç»ªæ ‡ç­¾ -->
          <view class="form-section">
            <view class="section-label inline">
              <view class="css-battery-container battery-inline">
                <view class="css-battery">
                  <view class="battery-core">
                    <view class="battery-bolt"></view>
                  </view>
                </view>
              </view>
              <text>å‹¾é€‰æƒ…ç»ªæ ‡ç­¾</text>
            </view>
            <view class="mood-picker-container">
              <view class="picker-display" bindtap="toggleMoodDropdown">
                <text class="picker-text {{selectedMoodTags.length > 0 ? 'active' : 'placeholder'}}">{{selectedMoodTags.length > 0 ? selectedMoodTags[0] : 'ç‚¹å‡»é€‰æ‹©ä»Šæ—¥å¿ƒæƒ…...'}}</text>
                <view class="picker-arrow {{showMoodDropdown ? 'open' : ''}}"></view>
              </view>
              <view class="picker-dropdown {{showMoodDropdown ? 'show' : ''}}">
                <scroll-view scroll-y="true" class="dropdown-scroll">
                  <block wx:for="{{moodTags}}" wx:key="*this">
                    <view class="dropdown-item {{selectedMoodTags.length > 0 && selectedMoodTags[0] === item ? 'active' : ''}}" bindtap="onSelectMood" data-tag="{{item}}">
                      <text class="dropdown-text">{{item}}</text>
                    </view>
                  </block>
                </scroll-view>
              </view>
            </view>
          </view>

          <!-- ç¢ç¢å¿µ + éšæ‰‹æ‹ -->
          <view class="form-section">
            <view class="section-label inline">
              <view class="css-battery-container battery-inline">
                <view class="css-battery">
                  <view class="battery-core">
                    <view class="battery-bolt"></view>
                  </view>
                </view>
              </view>
              <text>ç¢ç¢å¿µ + éšæ‰‹æ‹</text>
            </view>
            <view class="note-upload-container">
               <view class="note-input-wrap">
                 <textarea class="note-input" placeholder="ä¸€å¥è¯ç¢ç¢å¿µ..." placeholder-class="note-placeholder" bindinput="onNoteInput" maxlength="20" />
                 <view class="note-counter">{{(userNote && userNote.length) || 0}}/20</view>
               </view>
               <view class="image-uploader" bindtap="chooseUserImage">
                  <image wx:if="{{userImage}}" src="{{userImage}}" mode="aspectFill" class="uploaded-image" />
                  <view wx:else class="upload-placeholder">+</view>
               </view>
            </view>
          </view>

          <!-- 4. ç”ŸæˆæŒ‰é’® -->
          <view class="submit-section">
            <button class="generate-btn" bindtap="generateEnergyCard">ç‚¹å‡»ç”Ÿæˆèƒ½é‡å¡ç‰‡</button>
          </view>

        </view>
      </scroll-view>
    </view>

    <!-- é—®ç­”å¼é¢æ¿ï¼šå‹‡æ°”è¡¥ç»™ç«™ -->
    <view class="content-panel qa-panel {{currentStyleIndex === 1 ? 'active' : ''}}">
      <scroll-view class="panel-scroll" scroll-y="true" enable-flex="true">
        <view class="qa-style">
          <view class="station-banner" wx:if="{{courageBannerImage}}">
            <view class="card-container station-card">
              <view class="card-image-section">
                <image class="card-image" src="{{courageBannerImage}}" mode="aspectFill" />
                <view class="banner-subtitle">2åˆ†é’Ÿï¼Œç»™ä»Šå¤©çš„å‹‡æ°”å……ä¸ªç”µ</view>
              </view>
              <view class="card-divider"></view>
            </view>
          </view>

          <view class="qa-title-section">
            <text class="qa-title font-size-{{fontSizeIndex}}">å‹‡æ°”è¡¥ç»™ç«™</text>
          </view>

          <view class="form-section">
            <view class="section-label inline">
              <text>é€‰æ‹©å½“æ—¥å‹‡æ°”è¡¥ç»™ä¸»é¢˜</text>
            </view>
            <picker mode="selector" range="{{courageThemeNames}}" bindchange="onCourageThemeChange">
              <view class="picker-display">
                <text class="picker-text {{selectedCourageThemeIndex >= 0 ? 'active' : 'placeholder'}}">{{selectedCourageThemeIndex >= 0 ? courageThemeNames[selectedCourageThemeIndex] : 'ç‚¹å‡»é€‰æ‹©ä¸»é¢˜...'}}</text>
                <view class="picker-arrow"></view>
              </view>
            </picker>
          </view>

          <view class="submit-section">
            <button class="generate-btn" bindtap="startCourageSupply">å¼€å§‹è¡¥ç»™</button>
          </view>

          <view class="form-section" wx:if="{{courageCompleted}}">
            <view class="section-label inline">
              <text>ä»Šæ—¥å‹‡æ°”å°äº‹</text>
            </view>
            <view class="note-upload-container">
              <textarea class="note-input" placeholder="å†™ä¸‹ä»Šå¤©çš„ä¸€ä»¶å°å‹‡æ°”..." placeholder-class="note-placeholder" bindinput="onCourageNoteInput" maxlength="80" />
              <view class="note-counter">{{(courageNote && courageNote.length) || 0}}/80</view>
            </view>
          </view>

          <view class="submit-section" wx:if="{{courageCompleted}}">
            <button class="generate-btn" bindtap="generateCourageCard">ç”Ÿæˆå‹‡æ°”å¡ç‰‡</button>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- ç‹¬å¤„å‡€åœŸç«™é¢æ¿ -->
    <view class="content-panel inspire-panel {{currentStyleIndex === 2 ? 'active' : ''}}">
      <scroll-view class="panel-scroll" scroll-y="true" enable-flex="true">
        <view class="energy-station-style">
          <!-- é¡¶éƒ¨ Banner å›¾ç‰‡ + æ–‡æ¡ˆ -->
          <view class="station-banner" wx:if="{{solitudeBannerImage}}">
            <view class="card-container station-card">
              <view class="card-image-section">
                <image class="card-image" src="{{solitudeBannerImage}}" mode="aspectFill" />
                <view class="banner-subtitle">è®¤çœŸç”Ÿæ´»çš„æ¯ä¸€å¤©ï¼Œéƒ½å€¼å¾—è¢«çè—</view>
              </view>
              <view class="card-divider"></view>
            </view>
          </view>

          <!-- 1. å¡«å†™æ¸…å• -->
          <view class="form-section">
            <view class="section-label inline">
              <text>å¡«å†™æ¸…å•ï¼šç‹¬å¤„å°äº‹</text>
            </view>
            <view class="note-input-wrap single">
              <textarea class="note-input" placeholder="æ¯”å¦‚ï¼šçœ‹å†·é—¨ç”µå½± / ç…®ä¸€ç¢—çƒ­æ±¤ / å…¬å›­æ™’å¤ªé˜³ / æ•´ç†æˆ¿é—´..." placeholder-class="note-placeholder" bindinput="onSolitudeThingInput" maxlength="12" />
              <view class="note-counter">{{(solitudeThing && solitudeThing.length) || 0}}/12</view>
            </view>
          </view>

          <!-- 2. ä¸Šä¼ ç…§ç‰‡ + ç”Ÿæ´»æ„Ÿå— -->
          <view class="form-section">
            <view class="section-label inline">
              <text>ä¸Šä¼ ç…§ç‰‡ + å†™ä¸€å¥ç”Ÿæ´»æ„Ÿå—</text>
            </view>
            <view class="note-upload-container">
               <view class="note-input-wrap">
                 <textarea class="note-input" placeholder="ä¸€å¥ç”Ÿæ´»æ„Ÿå—..." placeholder-class="note-placeholder" bindinput="onSolitudeNoteInput" maxlength="78" />
                 <view class="note-counter">{{(solitudeNote && solitudeNote.length) || 0}}/78</view>
               </view>
               <view class="image-uploader" bindtap="chooseSolitudeImage">
                  <image wx:if="{{solitudeImage}}" src="{{solitudeImage}}" mode="aspectFill" class="uploaded-image" />
                  <view wx:else class="upload-placeholder">+</view>
               </view>
            </view>
          </view>

          <!-- 3. ç”Ÿæˆå¡ç‰‡ -->
          <view class="submit-section">
            <button class="generate-btn light" bindtap="generateSolitudeCard">æ”¶è—æˆ‘çš„å°ç¡®å¹¸</button>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- æ—¶å…‰ç«™é¢æ¿ -->
    <view class="content-panel fashion-panel {{currentStyleIndex === 3 ? 'active' : ''}}">
      <scroll-view class="panel-scroll" scroll-y="true" enable-flex="true">
        <view class="energy-station-style">
          <!-- é¡¶éƒ¨ Banner å›¾ç‰‡ -->
          <view class="station-banner" wx:if="{{timeCapsuleBannerImage}}">
            <view class="card-container station-card">
              <view class="card-image-section">
                <image class="card-image" src="{{timeCapsuleBannerImage}}" mode="aspectFill" />
                <view class="banner-subtitle">å°å­˜æˆé•¿å¿ƒæ„¿ï¼Œé™å¾…æ—¶å…‰å¼€å¯</view>
              </view>
              <view class="card-divider"></view>
            </view>
          </view>

          <!-- 1. é€‰æ‹©æ—¥æœŸ -->
          <view class="form-section">
            <view class="section-label inline">
              <text>é€‰æ‹©å¼€å¯æ—¥æœŸ</text>
            </view>
            <picker mode="date" bindchange="onDateChange" value="{{selectedDate}}">
               <view class="picker-display">
                <text class="picker-text {{selectedDate ? 'active' : 'placeholder'}}">{{selectedDate || 'ç‚¹å‡»é€‰æ‹©æ—¥æœŸ...'}}</text>
                <view class="picker-arrow"></view>
              </view>
            </picker>
          </view>

          <!-- 2. å¡«å†™å¿ƒæ„¿ -->
          <view class="form-section">
            <view class="section-label inline">
              <text>å†™ç»™æœªæ¥çš„è‡ªå·±</text>
            </view>
            <view class="note-upload-container">
               <view class="note-input-wrap single">
                 <textarea class="note-input" placeholder="è¾“å…¥æ—¶å…‰èƒ¶å›Šå†…å®¹..." placeholder-class="note-placeholder" bindinput="onTimeCapsuleInput" value="{{timeCapsuleContent}}" maxlength="94" />
                 <view class="note-counter">{{(timeCapsuleContent && timeCapsuleContent.length) || 0}}/94</view>
               </view>
            </view>
          </view>

          <!-- 3. æŒ‰é’® -->
          <view class="submit-section">
            <button class="generate-btn" bindtap="saveTimeCapsule">å°å­˜æ—¶å…‰èƒ¶å›Š</button>
          </view>
          
           <view class="submit-section" style="margin-top: 24rpx;">
            <button class="generate-btn light" bindtap="generateTimeCapsuleCard">ç”Ÿæˆæ—¶å…‰èƒ¶å›Šå¡ç‰‡</button>
          </view>

          <!-- 4. åˆ—è¡¨ -->
          <view class="form-section" wx:if="{{timeCapsules.length > 0}}">
             <view class="section-label inline">
              <text>æˆ‘çš„æ—¶å…‰èƒ¶å›Š</text>
            </view>
             <view class="rm-list">
                <view class="rm-item {{item.notified ? 'rm-done' : ''}}" wx:for="{{timeCapsules}}" wx:key="id">
                  <view class="rm-top">
                    <view class="rm-top-left">
                      <view class="rm-dot"></view>
                      <text class="rm-time">{{item.dueAtStr}}</text>
                    </view>
                    <view class="rm-actions">
                       <view class="rm-status">
                         <view class="rm-status-text {{item.statusClass}}">{{item.statusLabel}}</view>
                       </view>
                       <view class="mini-btn" bindtap="removeTimeCapsule" data-id="{{item.id}}">åˆ é™¤</view>
                    </view>
                  </view>
                  <view class="rm-content">
                    <text class="rm-text">{{item.content}}</text>
                  </view>
                </view>
             </view>
          </view>

        </view>
      </scroll-view>
    </view>
  </view>
</view>

<!-- åº•éƒ¨éŸ³é¢‘æ’­æ”¾å™¨ -->
<view class="audio-player" wx:if="{{false}}">
  <view class="audio-controls">
    <view class="audio-btn {{isPlaying ? 'playing' : ''}}" bindtap="toggleAudioPlay">
      <view class="icon-play"></view>
      <view class="icon-pause"></view>
    </view>
    <view class="audio-info">
      <view class="audio-title">{{article.title}}</view>
      <view class="audio-progress-bar">
        <view class="audio-progress" style="width: {{audioProgress}}%;"></view>
        <view class="audio-knob" style="left: {{audioProgress}}%;"></view>
      </view>
      <view class="audio-time">{{audioTimeText || 'æš‚æ— éŸ³é¢‘'}}</view>
    </view>
  </view>
</view>

<!-- å‹‡æ°”è¡¥ç»™è‡ªå®šä¹‰å¼¹çª— -->
<view class="courage-modal-overlay" wx:if="{{showCourageModal}}">
  <view class="courage-modal-content">
    <image class="modal-inner-bg" src="/assets/images/splash-bg.png" mode="aspectFill" />
    <text class="courage-modal-title">{{courageThemeNames[selectedCourageThemeIndex]}}</text>
    <text class="courage-modal-step">æ­¥éª¤ {{currentCourageStepIndex + 1}}/{{courageThemes[selectedCourageThemeIndex].steps.length}}</text>
    <scroll-view scroll-y="true" class="courage-modal-body">
      <text class="courage-modal-text">{{courageThemes[selectedCourageThemeIndex].steps[currentCourageStepIndex]}}</text>
    </scroll-view>
    <view class="courage-modal-buttons">
      <button class="courage-modal-btn cancel" bindtap="onCourageModalCancel">ç¨å</button>
      <button class="courage-modal-btn confirm" bindtap="onCourageModalConfirm">å®Œæˆ</button>
    </view>
  </view>
  </view>
