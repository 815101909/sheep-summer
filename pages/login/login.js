// pages/login/login.js
Page({
  data: {
    agreementChecked: false,
    showAgreementModal: false,
    agreementContent: `一、协议的确认与接受
1.1 本协议由用户（以下简称“您”）与绵羊时间软件（以下简称“平台”）就您使用平台所提供的相关服务所订立，具有法律约束力。
1.2 在您注册、下载、安装、登录、使用平台服务或以其他方式接受平台服务之前，请您务必仔细阅读并充分理解本协议所有条款，特别是涉及免除或限制责任、权利义务、争议解决的条款。
1.3 当您点击“同意”或以其他形式使用平台服务，即视为您已阅读、理解并同意接受本协议的全部内容；若您不同意本协议的任何条款，请立即停止使用平台服务。

二、服务内容
2.1 平台向您提供的服务包括但不限于：
2.1.1 用户注册、登录、账户管理；
2.1.2 APP 的下载、安装、更新与升级；
2.1.3 用户信息的查询、编辑与修改；
2.1.4 系统通知、消息推送与提醒；
2.1.5 用户隐私保护与信息安全管理；
2.1.6 用户协议与服务条款的展示与解释。
2.2 平台有权根据运营情况和法律法规的要求，随时对服务内容进行新增、变更、中断或终止，无需事先通知用户。
2.3 用户在使用平台新增服务时，仍应遵守本协议的约定，除非另有明确说明。

三、用户权利与义务
3.1 用户有权在遵守本协议及相关规则的前提下使用平台服务。
3.2 用户在使用平台服务过程中，应当遵守中华人民共和国相关法律法规及社会公序良俗，不得利用平台从事任何违法违规行为，包括但不限于：
3.2.1 发布、传输或存储违法、违规内容；
3.2.2 侵害他人知识产权、隐私权或其他合法权益；
3.2.3 恶意注册账号、伪造身份、传播恶意软件；
3.2.4 干扰、破坏平台正常运行。
3.3 用户应妥善保管账号及密码，不得出租、出借或转让账号。因用户保管不善导致的损失由用户自行承担。
3.4 用户保证所填写、提交的个人资料真实、准确、完整，并及时更新。如因提供虚假信息造成的后果，由用户自行承担。

四、平台权利与义务
4.1 平台有权对用户的使用行为进行监督，如发现用户违反本协议或相关法律法规的，有权采取警告、限制、冻结、终止服务等措施。
4.2 平台将持续优化和改进服务，但不保证服务的绝对无误、连续性或满足用户特定需求。
4.3 平台有权通过公告、邮件、短信、系统通知等方式向用户发送与服务相关的信息。
4.4 平台将依据法律法规的规定，采取必要措施保护用户个人信息的安全，但在符合法律法规或政府机关要求时，有权披露相关信息。

五、知识产权
5.1 平台在服务中使用的所有软件、技术、界面设计、文字、图像、视频、音频等内容，其知识产权归平台或相关权利人所有。未经许可，用户不得复制、传播、修改、反向工程或用于商业目的。
5.2 用户在使用平台过程中生成的内容，其知识产权归用户本人或原始权利人所有。但用户同意授予平台在法律允许的范围内，出于提供服务之必要而进行使用、存储、展示的权利。
5.3 用户不得以任何形式侵犯平台或第三方的知识产权，若因用户行为导致纠纷，责任由用户自行承担。

六、协议的变更与终止
6.1 平台有权根据法律法规及运营需要对本协议进行修改，并通过公告或其他适当方式告知用户。修改后的协议一经公布即生效。
6.2 若用户不同意修改内容，有权停止使用平台服务；若继续使用，则视为接受修改后的协议。
6.3 平台有权随时基于自身判断中止或终止对用户的服务，用户也有权随时注销账号并终止本协议。

七、免责条款
7.1 用户在使用平台服务过程中应自行承担风险。
7.2 对因不可抗力或非平台原因（包括但不限于自然灾害、网络故障、病毒攻击、系统问题、第三方服务问题等）导致的损失，平台不承担责任。
7.3 因用户自身行为或第三方原因造成的损失，平台不承担任何直接或间接责任。

八、争议解决
8.1 本协议的订立、生效、履行、解释及争议解决，均适用中华人民共和国法律。
8.2 因本协议引起的或与本协议有关的争议，双方应友好协商解决；协商不成的，应提交平台所在地有管辖权的人民法院诉讼解决。

九、平台致谢
9.1 本产品部分图标素材来源于 https://igoutu.cn/icons/，相关素材的知识产权归原权利人所有，本产品仅基于合法授权进行使用。
9.2 用户不得单独提取、转载、售卖或用于其他未经授权的商业用途，如需另行使用该平台图标素材，应自行获得原权利人许可。

十、其他
10.1 本协议的部分条款因任何原因被认定为无效或不可执行，不影响其余条款的效力。
10.2 本协议的最终解释权归平台所有。`
  },

  onLoad: function (options) {
    // 页面加载时的初始化
  },

  onShow: function () {
    // 页面显示时的操作
  },

  // 协议勾选状态改变
  onAgreementChange: function (e) {
    console.log('协议勾选状态改变:', e.detail.value);
    const isChecked = e.detail.value.includes('agreement');
    this.setData({
      agreementChecked: isChecked
    });
    console.log('当前agreementChecked状态:', this.data.agreementChecked);
  },

  // 登录按钮点击
  onLogin: function () {
    console.log('点击登录，当前agreementChecked状态:', this.data.agreementChecked);
    if (!this.data.agreementChecked) {
      wx.showToast({
        title: '请先勾选用户协议',
        icon: 'none',
        duration: 2000
      });
      return;
    }

    // 显示加载中
    wx.showLoading({
      title: '登录中...'
    });

    // 调用云函数登录
    // 使用全局配置的跨账号云实例
    const cloud = getApp().cloud || wx.cloud;
    
    cloud.callFunction({
      name: 'login',
      data: {},
      success: res => {
        console.log('[云函数] [login] result: ', res.result)
        wx.hideLoading();

        if (!res.result.userInfo) {
          console.error('[云函数] [login] 登录异常，未返回用户信息:', res.result.error);
          wx.showModal({
            title: '登录异常',
            content: '无法获取用户信息，请联系管理员或稍后重试。\n错误信息: ' + (res.result.error ? res.result.error.errMsg || JSON.stringify(res.result.error) : '未知错误'),
            showCancel: false
          });
          return;
        }

        console.log('[云函数] [login] user openid: ', res.result.openid)

        // 设置登录状态到全局或本地存储
        wx.setStorageSync('isLoggedIn', true);
        wx.setStorageSync('openid', res.result.openid);
        
        // 保存完整的用户信息到本地
        const cloudUserInfo = res.result.userInfo;
        wx.setStorageSync('userInfo', cloudUserInfo);
        
        // 保存用户名，优先使用云端返回的 nickName
        const nickName = (cloudUserInfo && cloudUserInfo.nickName) || '夏小咩';
        wx.setStorageSync('userName', nickName);

        // 记录登录天数
        this.recordLoginDay();

        wx.showToast({
          title: '登录成功',
          icon: 'success',
          duration: 1500
        });

        // 延迟返回上一页
        setTimeout(() => {
          wx.navigateBack({
            delta: 1
          });
        }, 1500);
      },
      fail: err => {
        console.error('[云函数] [login] 调用失败', err)
        wx.hideLoading();
        wx.showToast({
          title: '登录失败，请重试',
          icon: 'none',
          duration: 2000
        });
      }
    })
  },

  // 隐私政策点击
  onPrivacyTap: function () {
    this.setData({
      modalTitle: '绵羊时间软件平台隐私政策',
      modalContent: `引言

绵羊时间软件平台（以下简称“我们”或“平台”）尊重并保护用户（以下简称“您”）的个人信息与隐私安全。为向您提供产品与/或服务并保障网络与数据安全，我们依据《中华人民共和国个人信息保护法》《中华人民共和国网络安全法》《中华人民共和国民法典》及相关配套规范（如《信息安全技术 个人信息安全规范》）制定本政策，说明我们如何收集、使用、共享、保存及保护您的个人信息，并阐明您依法享有的权利。

与您权益密切相关的条款（如个人信息处理规则、未成年人保护、对外共享、用户权利与行使方式、争议解决等）已作醒目标识，请您重点阅读。 当您点击同意或开始/继续使用平台产品与/或服务，即表示您已充分阅读、理解并接受本政策全部内容；若您不同意，请立即停止使用。


一、适用范围与角色说明

1. 本政策适用于您通过平台提供的移动应用（App）、网站及其后续新增的产品与/或服务。
2. 就本政策所涉个人信息处理活动，我们通常作为“个人信息处理者”履行法定义务；如涉及受托处理或共同处理，将在相应场景另行告知。
3. 如某些业务另行制定专项规则/协议（如《儿童/未成年人隐私政策》《小舟摇平台服务协议》），与本政策不一致时，以专项规则为准。


二、我们如何收集与使用您的个人信息

我们遵循最小必要、公开透明、目的明确原则，在实现产品/服务功能、保障安全与合规的范围内处理个人信息。不同功能可能需要不同信息与设备权限，您可自主选择是否授权；拒绝授权仅会影响对应功能，不影响其他功能的使用（法律法规另有规定或为实现核心功能所必需的除外）。

1. 账户注册与登录

1.1为创建并管理您的账户，我们可能收集：手机号码（用于注册、登录与验证）。
1.2若您使用第三方账号登录（如微信/支付宝/Apple ID 等），在您授权后我们将获取第三1.3提供的头像、昵称、地区/性别（如有）以完成账号绑定；如需关联会员权益，可能仍需收集您的手机号码。
1.4您可自愿完善个人资料（如头像、昵称、性别、年级等）；不提供不影响基础使用。

2. 功能使用与设备权限

为实现特定功能，我们可能调用以下权限：

2.1相册/存储：用于上传头像、保存图片/海报等；
2.2摄像头：用于拍摄头像或扫描二维码等；
2.3麦克风：用于语音录入（如开启相应功能时）；
2.4通知：用于向您推送服务提醒、消息通知；
2.5网络：用于联网以获取与同步内容。

您可在设备“设置”中随时关闭相应权限，关闭后可能无法使用对应功能。

3. 安全运行与风险控制

为保障账户与交易安全、确保服务稳定运行、预防违规与欺诈，我们可能收集以下信息用于安全风控与异常检测：

3.1设备信息（如设备型号、设备名称、操作系统与版本、应用版本、设备标识符（如 Android ID/IDFA/IDFV）等）；
3.2日志信息（如登录/操作日志、网络请求、崩溃日志）。

我们不会用于与安全无关的目的。为实现持续的异常检测，程序重启或关键操作时可能再次读取相关信息，但会控制频次在合理范围。

4. 购买与支付

当您购买会员/增值服务时，支付由第三方支付机构（如微信支付/支付宝等）处理。我们可能会接收来自第三方的支付结果（成功/失败、金额、时间等）用于完成订单与售后；必要时记录您的第三方支付账户标识。我们不直接处理银行卡号等敏感支付信息。

5. 剪贴板与兑换码

为便于您使用兑换码，在您主动进入兑换页面并粘贴时，应用可能请求读取剪贴板获取兑换码；除兑换目的外我们不会存储或分享剪贴板的其他内容。

6. 客服与用户反馈

当您联系客户服务或提交反馈时，为了核验身份、定位问题与回复处理，我们可能收集您提供的联系方式、问题描述、相关截图/录音等信息。

7. 统计分析与产品优化

为提升产品性能与用户体验，我们可能在去标识化/汇总统计层面分析功能使用频率、崩溃信息、页面停留时长等数据，用于判断产品可用性、排查问题与优化功能。我们不会将上述分析用于个体精准画像或与第三方共享用于营销。

8. 可能处理的敏感个人信息

在确属必要且依法合规的前提下（例如实现身份验证、保障交易安全），我们才会处理可能被认定为敏感个人信息的项目，并在处理前取得您的明示同意。如您不同意，可能无法使用该特定功能，但不影响其他功能。


三、Cookies 与本地存储

我们及合作方可能使用 Cookies/本地存储 以记住您的偏好、维持会话状态、改进体验与统计分析。您可通过浏览器或系统设置清除或禁用相关技术，但可能影响部分功能可用性。


四、我们如何共享、转让与公开披露您的个人信息

1. 共享：除非取得您的明示同意或法律法规另有规定，我们不会与任何第三方共享您的个人信息。为向您提供服务所必需的场景（如云服务、消息推送、统计分析、支付、第三方登录等），我们可能与合作方共享为实现该目的所必需的最少信息，并与其签署严格的数据保护协议，要求其仅在授权范围内使用并采取不低于我们的保护措施。
2. 转让：在发生合并、分立、重组、资产/业务转让、破产清算等情形导致个人信息转移时，我们将告知接收方名称与联系方式，并要求其继续受本政策约束；如接收方变更处理目的/方式，我们将重新获得您的同意。
3. 公开披露：我们原则上不公开披露您的个人信息；如确需披露（如公示中奖名单的部分昵称等），将明示披露目的与信息范围并取得您的同意或进行匿名化处理。
4. 依法提供：根据法律法规或监管/司法机关依法提出的要求，我们可能在履行合法程序后提供相关信息。

五、第三方SDK与受托处理

为实现部分功能，我们可能接入第三方SDK或委托第三方处理个人信息。我们会对其合法性、正当性、必要性与安全性进行评估，并与其签订数据保护条款，督促其合规处理。


六、信息存储、保存期限与删除

1. 存储地点：原则上存放于中华人民共和国境内；如因业务需要发生跨境提供，我们将按法律要求履行安全评估/认证/签署标准合同并单独征得您的明示同意。
2. 保存期限：在达成处理目的所必需的最短期间内保存；超出期限或您主动注销/删除、撤回同意后，我们将删除或匿名化处理（法律法规另有规定或为保护您、我们或社会公共利益所必需的除外）。
3. 备份与日志：出于安全合规需要，备份与日志会保留合理期限并在到期后安全删除。

七、我们如何保护您的信息

我们已采取与业务相匹配的技术与管理措施：包括但不限于数据分级分类、最小权限控制、访问审计、加密传输与加密存储、脱敏/去标识化处理、安全开发流程、员工安全培训与保密义务、应急演练与第三方合规评估等。

尽管我们已尽力采取合理措施，受限于技术与风险的不确定性，无法保证100%安全。一旦发生或可能发生信息安全事件，我们将启动应急预案、降低风险、及时告知您事件基本情况、可能影响、已采取或将采取的措施、您可自行防范的建议等；对影响重大的，将按规定向主管部门报告。

 八、未成年人保护

我们的产品与/或服务并非专门面向未成年人。如您为未成年人（尤其不满14周岁的儿童），应在监护人同意与指导下使用本产品并提交个人信息。

8.1对经监护人同意后收集的未成年人的个人信息，我们仅在法律允许、监护人明确同意或为保护未成年人所必需时处理。
8.2若我们在未获可验证监护人同意的情况下收集了未成年人信息，将设法尽快删除。
8.3如我们未来提供专门面向儿童的服务，将另行提供并遵守《小舟摇儿童隐私政策》。


九、您的权利与行使方式

在符合法律法规的前提下，您对个人信息享有以下权利，我们通常将在15个工作日内予以处理（特殊复杂情形可依法延长并告知理由）：

1. 访问与副本：您可在“我的—设置—个人信息”中查看或向我们申请获取您的信息副本。
2. 更正与补充：如信息有误或不完整，您可自行修改或申请我们更正。
3. 删除：在出现法定情形（如处理目的已达成/无法达成、超出必要范围、撤回同意、违法处理等）时，您可请求删除。
4. 撤回同意：对于基于同意的处理，您可随时撤回（如关闭某项权限/个性化推荐/统计分析）。撤回不影响撤回前基于同意的处理活动。
5. 账号注销：您可在 App “我的—设置—账户与安全—注销账号”发起，或通过客服渠道申请。注销为不可逆操作，注销后我们将删除或匿名化处理您的相关信息（法律另有规定的除外）。
6. 限制或拒绝自动化决策：对可能基于自动化决策（如个性化推荐）产生的决定，您有权请求解释，并有权拒绝营销类个性化推荐。
7. 数据可携权（在符合法定条件时）：您可申请我们将符合条件的个人信息向指定个人信息处理者转移。

出于安全考虑，我们可能需要验证您的身份；对不合理重复、超出技术可行、侵害他人权益或与法律冲突的请求，我们可能依法予以拒绝并说明理由。


十、政策的变更与通知

为适应法律法规或业务变化，我们可能更新本政策。重大变更（如处理目的、处理类型、共享对象、用户权利方式等）将通过弹窗、站内信、公告或邮件进行显著通知，并在合理期限内（原则上至少提前7日）生效。继续使用即视为您接受变更后的政策。


十一、如何联系我们

如对本政策或个人信息保护有任何疑问、建议或投诉，您可通过以下方式与我们联系：
客服邮箱：xiaoxiaovision@foxmail.com
    我们将在核验身份后，15个工作日内予以答复。若您对我们的答复不满意，且与个人信息处理有关，您亦可向有管辖权的监管部门进行投诉或依法提起诉讼。


十二、适用法律与争议解决

本政策的订立、生效、履行、解释及争议解决适用中华人民共和国法律。因本政策产生或与之有关的争议，双方应先行友好协商；协商不成的，提交平台所在地有管辖权的人民法院诉讼解决。`,
      showAgreementModal: true
    });
  },

  // 用户协议点击
  onTermsTap: function () {
    if (getApp().playClickSound) getApp().playClickSound();
    this.setData({
      modalTitle: '绵羊时间用户服务协议',
      modalContent: this.data.agreementContent,
      showAgreementModal: true
    });
  },
  closeAgreementModal: function () {
    this.setData({ showAgreementModal: false });
  },

  // 记录登录天数
  recordLoginDay: function () {
    const today = new Date().toDateString();
    let loginRecords = wx.getStorageSync('loginRecords') || [];

    // 检查今天是否已经记录过
    if (!loginRecords.includes(today)) {
      loginRecords.push(today);
      wx.setStorageSync('loginRecords', loginRecords);
    }
  }
});
