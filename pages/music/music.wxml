<!--pages/music/music.wxml-->
<view class="container {{themeClass}}">
  <image class="bg-image" src="/assets/images/splash-bg.png" mode="aspectFill" lazy-load="true"></image>

  <!-- MP3æ’­æ”¾å™¨ä¸»ä½“ -->
  <view class="mp3-player">
    <!-- MP3å¤–å£³ -->
    <view class="mp3-body">
      <!-- å±å¹•åŒºåŸŸ -->
      <view class="mp3-screen">
        <view class="screen-content">
          <!-- åª’ä½“æ˜¾ç¤ºåŒºåŸŸï¼ˆä½œä¸ºèƒŒæ™¯å±‚ï¼‰ -->
          <view class="media-display">
            <video 
              wx:if="{{currentSong.videoUrl}}" 
              id="songVideo" 
              class="screen-media" 
              src="{{currentSong.videoUrl}}" 
              poster="{{currentSong.imageUrl || currentSong.posterUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='}}"
              controls="{{false}}" 
              autoplay="{{isPlaying}}"
              show-center-play-btn="{{false}}"
              loop="{{true}}"
              object-fit="contain"
              muted="{{true}}">
            </video>
            <image 
              wx:elif="{{!currentSong.videoUrl}}" 
              class="screen-media" 
              src="{{currentSong.imageUrl || currentSong.posterUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='}}" 
              mode="aspectFit"
              lazy-load="true">
            </image>
            <!-- é»˜è®¤æ˜¾ç¤ºçš„åŠ¨ç”»æˆ–å ä½ -->
            <view wx:else class="default-visual screen-media">
               <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸€ä¸ªé»˜è®¤çš„éŸ³ä¹å¾‹åŠ¨åŠ¨ç”»æˆ–è€…å›¾æ ‡ -->
            </view>
          </view>

          <!-- æ­Œæ›²ä¿¡æ¯ï¼ˆæ‚¬æµ®å±‚ï¼‰ -->
          <view class="song-info">
            <text class="song-title" style="font-size: {{fontSize === 'small' ? '32rpx' : fontSize === 'large' ? '42rpx' : '37rpx'}}; color: {{fontColor === 'black' ? '#000000' : fontColor === 'white' ? '#ffffff' : fontColor === 'green' ? '#00ff00' : fontColor === 'blue' ? '#0088ff' : fontColor === 'red' ? '#ff0000' : '#ffd700'}}; font-family: 'Courier New', monospace; font-weight: {{fontSize === 'small' ? 'normal' : 'bold'}}; text-shadow: 2rpx 2rpx 0px {{fontColor === 'black' ? '#666666' : fontColor === 'white' ? '#cccccc' : fontColor === 'green' ? '#004400' : fontColor === 'blue' ? '#004466' : fontColor === 'red' ? '#440000' : '#665500'}}; image-rendering: pixelated; text-rendering: optimizeSpeed">{{currentSong.title || 'åˆå¤å°å¤œæ›²'}}</text>
            <text class="song-artist" style="font-size: {{fontSize === 'small' ? '20rpx' : fontSize === 'large' ? '28rpx' : '24rpx'}}; color: {{fontColor === 'black' ? '#000000' : fontColor === 'white' ? '#ffffff' : fontColor === 'green' ? '#00cc00' : fontColor === 'blue' ? '#0088ff' : fontColor === 'red' ? '#cc0000' : '#ffed4e'}}; font-family: 'Courier New', monospace; text-shadow: 1rpx 1rpx 0px {{fontColor === 'black' ? '#666666' : fontColor === 'white' ? '#cccccc' : fontColor === 'green' ? '#004400' : fontColor === 'blue' ? '#004466' : fontColor === 'red' ? '#440000' : '#665500'}}; image-rendering: pixelated; text-rendering: optimizeSpeed">{{currentSong.artist || 'å¤æ—¥éŸ³ä¹å®¶'}}</text>
          </view>

          <!-- æ­Œè¯æ˜¾ç¤ºåŒºåŸŸï¼ˆå­—å¹•å¼ï¼Œæ‚¬æµ®å±‚ï¼‰ -->
          <view class="lyrics-subtitle">
            <text class="lyrics-text" style="text-align: center; font-size: {{fontSize === 'small' ? '26rpx' : fontSize === 'large' ? '32rpx' : '28rpx'}}; color: {{fontColor === 'black' ? '#000000' : fontColor === 'white' ? '#ffffff' : fontColor === 'green' ? '#00ff00' : fontColor === 'blue' ? '#0088ff' : fontColor === 'red' ? '#ff0000' : '#ffd700'}}; font-family: 'Courier New', monospace; font-weight: bold; text-shadow: 2rpx 2rpx 0px {{fontColor === 'black' ? '#666666' : fontColor === 'white' ? '#cccccc' : fontColor === 'green' ? '#004400' : fontColor === 'blue' ? '#004466' : fontColor === 'red' ? '#440000' : '#665500'}}; image-rendering: pixelated; text-rendering: optimizeSpeed">{{currentLyricsLine.text || '...'}}</text>
          </view>

          <!-- è¿›åº¦æ¡ï¼ˆæ‚¬æµ®å±‚ï¼‰ -->
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{progress}}%; background: {{fontColor === 'black' ? 'linear-gradient(90deg, #666666, #888888)' : fontColor === 'white' ? 'linear-gradient(90deg, #ffffff, #cccccc)' : fontColor === 'green' ? 'linear-gradient(90deg, #00ff88, #88ffaa)' : fontColor === 'blue' ? 'linear-gradient(90deg, #0088ff, #88ccff)' : fontColor === 'red' ? 'linear-gradient(90deg, #ff4444, #ff8888)' : 'linear-gradient(90deg, #ffd700, #ffed4e)'}}; box-shadow: 0 0 8rpx {{fontColor === 'black' ? 'rgba(102, 102, 102, 0.5)' : fontColor === 'white' ? 'rgba(255, 255, 255, 0.5)' : fontColor === 'green' ? 'rgba(0, 255, 136, 0.5)' : fontColor === 'blue' ? 'rgba(0, 136, 255, 0.5)' : fontColor === 'red' ? 'rgba(255, 68, 68, 0.5)' : 'rgba(255, 215, 0, 0.5)'}}"></view>
          </view>

          <!-- æ—¶é—´æ˜¾ç¤ºï¼ˆæ‚¬æµ®å±‚ï¼‰ -->
          <view class="time-display">
            <text class="current-time" style="color: {{fontColor === 'black' ? '#000000' : fontColor === 'white' ? '#ffffff' : fontColor === 'green' ? '#00aa00' : fontColor === 'blue' ? '#0088ff' : fontColor === 'red' ? '#ff0000' : '#ffd700'}}">{{currentTime}}</text>
            <text class="total-time" style="color: {{fontColor === 'black' ? '#000000' : fontColor === 'white' ? '#ffffff' : fontColor === 'green' ? '#00aa00' : fontColor === 'blue' ? '#0088ff' : fontColor === 'red' ? '#ff0000' : '#ffd700'}}">{{totalTime}}</text>
          </view>
        </view>
      </view>

      <!-- åŠŸèƒ½æ  -->
      <view class="function-bar">
        <text class="function-text {{activePanel === 'speed' ? 'active' : ''}}" bindtap="togglePanel" data-panel="speed">å€é€Ÿæœ—è¯»</text>
        <text class="function-text {{activePanel === 'fontSize' ? 'active' : ''}}" bindtap="togglePanel" data-panel="fontSize">å­—ä½“å¤§å°</text>
        <text class="function-text {{activePanel === 'fontColor' ? 'active' : ''}}" bindtap="togglePanel" data-panel="fontColor">å­—ä½“é¢œè‰²</text>
      </view>

      <!-- ç‚¹å‡»é®ç½©å…³é—­é¢æ¿ -->
      <view wx:if="{{activePanel}}" class="overlay" bindtap="closePanel"></view>

      <!-- å±•å¼€é¢æ¿ -->
      <view wx:if="{{activePanel}}" class="expand-panel visible">
        <!-- å€é€Ÿé€‰é¡¹ -->
        <view wx:if="{{activePanel === 'speed'}}" class="panel-content active">
          <view class="panel-header">é€‰æ‹©æ’­æ”¾å€é€Ÿ</view>
          <view class="option-grid">
            <view class="option-btn {{playbackRate === 0.85 ? 'selected' : ''}}" bindtap="setPlaybackRate" data-rate="0.85">
              <text class="option-text">0.85x</text>
            </view>
            <view class="option-btn {{playbackRate === 1.0 ? 'selected' : ''}}" bindtap="setPlaybackRate" data-rate="1.0">
              <text class="option-text">1.0x</text>
            </view>
            <view class="option-btn {{playbackRate === 1.25 ? 'selected' : ''}}" bindtap="setPlaybackRate" data-rate="1.25">
              <text class="option-text">1.25x</text>
            </view>
          </view>
        </view>

        <!-- å­—ä½“å¤§å°é€‰é¡¹ -->
        <view wx:if="{{activePanel === 'fontSize'}}" class="panel-content active">
          <view class="panel-header">é€‰æ‹©å­—ä½“å¤§å°</view>
          <view class="size-options">
            <view class="size-option {{fontSize === 'small' ? 'selected' : ''}}" bindtap="setFontSize" data-size="small">
              <text class="size-text">å°</text>
            </view>
            <view class="size-option {{fontSize === 'medium' ? 'selected' : ''}}" bindtap="setFontSize" data-size="medium">
              <text class="size-text">ä¸­</text>
            </view>
            <view class="size-option {{fontSize === 'large' ? 'selected' : ''}}" bindtap="setFontSize" data-size="large">
              <text class="size-text">å¤§</text>
            </view>
          </view>
        </view>

        <!-- å­—ä½“é¢œè‰²é€‰é¡¹ -->
        <view wx:if="{{activePanel === 'fontColor'}}" class="panel-content active">
          <view class="panel-header">é€‰æ‹©å­—ä½“é¢œè‰²</view>
          <view class="color-options">
            <view class="color-option {{fontColor === 'black' ? 'selected' : ''}}" bindtap="setFontColor" data-color="black">
              <view class="color-swatch black"></view>
              <text class="color-label">é»‘è‰²</text>
            </view>
            <view class="color-option {{fontColor === 'white' ? 'selected' : ''}}" bindtap="setFontColor" data-color="white">
              <view class="color-swatch white"></view>
              <text class="color-label">ç™½è‰²</text>
            </view>
            <view class="color-option {{fontColor === 'green' ? 'selected' : ''}}" bindtap="setFontColor" data-color="green">
              <view class="color-swatch green"></view>
              <text class="color-label">ç»¿è‰²</text>
            </view>
            <view class="color-option {{fontColor === 'blue' ? 'selected' : ''}}" bindtap="setFontColor" data-color="blue">
              <view class="color-swatch blue"></view>
              <text class="color-label">è“è‰²</text>
            </view>
            <view class="color-option {{fontColor === 'red' ? 'selected' : ''}}" bindtap="setFontColor" data-color="red">
              <view class="color-swatch red"></view>
              <text class="color-label">çº¢è‰²</text>
            </view>
            <view class="color-option {{fontColor === 'goose' ? 'selected' : ''}}" bindtap="setFontColor" data-color="goose">
              <view class="color-swatch goose"></view>
              <text class="color-label">é¹…é»„è‰²</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
      <view class="mp3-controls">
        <!-- æ’­æ”¾æ§åˆ¶é¢æ¿ï¼ˆå±…ä¸­ï¼‰ -->
        <view class="control-panel">
          <!-- ç¬¬ä¸€è¡Œï¼šè£…é¥°å’Œä¸‹è½½æŒ‰é’® -->
          <view class="control-row">
            <view class="control-btn decoration-btn">
              <image class="decoration-icon" src="/assets/images/è£…é¥°.png" mode="aspectFit"></image>
            </view>
            <view class="control-btn download-btn" bindtap="downloadSong">
              <image class="control-icon-img" src="/assets/images/ä¸‹è½½.png" mode="aspectFit"></image>
            </view>
          </view>

          <!-- ç¬¬äºŒè¡Œï¼šå››ä¸ªæŒ‰é’® -->
          <view class="control-row">
            <view class="control-btn prev-btn" bindtap="prevSong">
              <image class="control-icon-img" src="/assets/images/å€’å¸¦.png" mode="aspectFit"></image>
            </view>
            <view class="control-btn play-btn main-btn" bindtap="togglePlay">
              <image class="control-icon-img" src="{{isPlaying ? '/assets/images/stop.png' : '/assets/images/play.png'}}" mode="aspectFit"></image>
            </view>
            <view class="control-btn mode-btn main-btn" bindtap="cyclePlayMode">
              <image class="control-icon-img" src="{{playMode === 'list' ? '/assets/images/åˆ—è¡¨å¾ªç¯.png' : playMode === 'single' ? '/assets/images/å•æ›²å¾ªç¯.png' : '/assets/images/éšæœºæ’­æ”¾.png'}}" mode="aspectFit"></image>
            </view>
            <view class="control-btn next-btn" bindtap="nextSong">
              <image class="control-icon-img" src="/assets/images/å¿«è¿›.png" mode="aspectFit"></image>
            </view>
          </view>

          <!-- ç¬¬ä¸‰è¡Œï¼šæ”¶è—æŒ‰é’®å’Œæ’­æ”¾åˆ—è¡¨æŒ‰é’® -->
          <view class="control-row">
            <view class="control-btn favorite-btn" bindtap="toggleFavorite">
              <image class="control-icon-img" src="{{isFavorite ? '/assets/images/ç‚¹å‡»å–œæ¬¢å.png' : '/assets/images/å–œæ¬¢æŒ‰é’®åŸå§‹çŠ¶æ€.png'}}" mode="aspectFit"></image>
            </view>
            <view class="control-btn playlist-btn" bindtap="togglePlaylist">
              <image class="control-icon-img" src="/assets/images/æ’­æ”¾åˆ—è¡¨.png" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>

      <!-- MP3å“ç‰Œæ ‡è¯† -->
      <view class="mp3-brand">
        <text class="brand-text">å¤æ—¥éšèº«å¬</text>
        <text class="brand-subtitle">Summer MP3 Player</text>
      </view>
    </view>
    </view>

  <!-- æ­Œæ›²åˆ—è¡¨ -->
  <view class="playlist-panel {{showPlaylist ? 'visible' : ''}}">
    <view class="playlist-header">
      <view class="header-top">
        <text class="playlist-title">æ’­æ”¾åˆ—è¡¨</text>
        <view class="header-actions">
          <view class="reset-btn" bindtap="resetFilters">â†º</view>
          <view class="close-playlist" bindtap="togglePlaylist">âœ•</view>
        </view>
      </view>
      <!-- æœç´¢å’Œç­›é€‰æ  -->
      <view class="search-bar">
        <input class="search-input" placeholder="æœç´¢" placeholder-class="search-placeholder" bindinput="onSearchInput" value="{{searchQuery}}" />
        <view class="dropdown-container">
          <view class="dropdown-trigger" bindtap="toggleTypeDropdown">
            <text class="dropdown-text">{{selectedTypeText || 'é€‰æ‹©ç±»å‹'}}</text>
          </view>
          <view class="dropdown-list" wx:if="{{showTypeDropdown}}">
            <view wx:for="{{typeOptions}}" wx:key="*this" class="dropdown-item {{item === selectedTypeText ? 'active' : ''}}" bindtap="selectType" data-type="{{item}}">
              {{item}}
            </view>
          </view>
        </view>
        <view class="dropdown-container">
          <view class="dropdown-trigger" bindtap="togglePersonDropdown">
            <text class="dropdown-text">{{selectedPersonText || 'é€‰æ‹©äººç‰©'}}</text>
          </view>
          <view class="dropdown-list" wx:if="{{showPersonDropdown}}">
            <view wx:for="{{personOptions}}" wx:key="*this" class="dropdown-item {{item === selectedPersonText ? 'active' : ''}}" bindtap="selectPerson" data-person="{{item}}">
              {{item}}
            </view>
          </view>
        </view>
        <view class="dropdown-container">
          <view class="dropdown-trigger" bindtap="toggleTopicDropdown">
            <text class="dropdown-text">{{selectedTopicText || 'é€‰æ‹©ä¸“é¢˜'}}</text>
          </view>
          <view class="dropdown-list" wx:if="{{showTopicDropdown}}">
            <view wx:for="{{topicOptions}}" wx:key="*this" class="dropdown-item {{item === selectedTopicText ? 'active' : ''}}" bindtap="selectTopic" data-topic="{{item}}">
              {{item}}
            </view>
          </view>
        </view>
        <view class="filter-btn {{filterFavorite ? 'active' : ''}}" bindtap="toggleFilterFavorite">
           <view class="css-heart {{filterFavorite ? 'filled' : ''}}"></view>
        </view>
      </view>
    </view>
    <view class="playlist-body">
      <scroll-view class="playlist-scroll" scroll-y="true" bindscrolltolower="onScrollToLower" lower-threshold="100">
        <view class="playlist-content">
          <view class="song-item {{item.originalIndex === currentSongIndex ? 'playing' : ''}}"
            wx:for="{{displayPlaylist}}"
            wx:key="originalIndex"
            bindtap="selectSong"
            data-index="{{item.originalIndex}}">
            <view class="song-number">{{index + 1}}</view>
            <view class="song-details">
              <view class="title-row">
                <view class="tags-inline" wx:if="{{item.topic || item.isVip}}">
                  <view class="tag-badge topic-tag" wx:if="{{item.topic}}">
                    <text class="tag-symbol">âœ¦</text>{{item.topic}}
                  </view>
                  <view class="tag-badge vip-tag" wx:if="{{item.isVip}}">VIP</view>
                </view>
                <text class="item-title">{{item.title}}</text>
              </view>
              <view class="song-meta">
                <text class="meta" wx:if="{{item.type}}">{{item.type}}</text>
                <text class="meta" wx:if="{{item.artist}}"> Â· {{item.artist}}</text>
                <text class="meta" wx:if="{{item.publishDateStr}}"> Â· {{item.publishDateStr}}</text>
              </view>
            </view>
            <view class="song-duration">{{item.duration}}</view>
            <view class="song-actions">
              <view class="print-btn" catchtap="openSongPrint" data-id="{{item._id}}">
                <text class="print-icon">ğŸ–¨ï¸</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

</view>
<view wx:if="{{showVipModal}}" class="vip-modal-mask">
  <view class="vip-modal">
    <view class="vip-title">ä¼šå‘˜ä¸“äº«</view>
    <view class="vip-content">è¯¥å†…å®¹ä¸ºä¼šå‘˜ä¸“äº«ï¼Œè¯·å…ˆå¼€é€šä¼šå‘˜</view>
    <view class="vip-actions">
      <button class="vip-btn cancel" bindtap="closeVipModal">æˆ‘çŸ¥é“äº†</button>
      <button class="vip-btn confirm" bindtap="goToVip">å»å¼€é€š</button>
    </view>
  </view>
</view>
